name: Release Please

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, closed]

jobs:
  release-please:
    runs-on: ubuntu-latest
    # Only run release-please on merge to main (not on PR events)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Release Please Action
        uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

      # Output when draft release is created
      - name: Draft Release Created
        if: ${{ steps.release.outputs.release_created }}
        run: |
          echo "ğŸ‰ Draft Release Created from PR titles!"
          echo "ğŸ“¦ Tag: ${{ steps.release.outputs.tag_name }}"
          echo "ğŸ“ CHANGELOG.md generated from merged PR titles"
          echo "ğŸ”— Draft Release URL: https://github.com/${{ github.repository }}/releases"
          echo "âœ… Review and publish the draft release when ready"

      # Output when no releasable changes found
      - name: No Release Changes
        if: ${{ !steps.release.outputs.release_created }}
        run: |
          echo "â„¹ï¸ No releasable PR titles found since last release"
          echo "ğŸ“ PR titles must use conventional format:"
          echo "   feat: add new feature"
          echo "   fix: resolve bug issue"
          echo "   feat!: breaking change"

  pr-validation:
    runs-on: ubuntu-latest
    # Only run on PR events
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Validate PR Title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "ğŸ” Validating PR title: $PR_TITLE"
          
          # Check if PR title follows conventional commit format
          if echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?!?:\s.+"; then
            echo "âœ… PR title follows conventional commit format"
            echo "ğŸ“ This will be included in the changelog when merged"
          else
            echo "âŒ PR title does not follow conventional commit format"
            echo "ğŸ“‹ Expected format: type: description"
            echo "ğŸ“‹ Examples:"
            echo "   feat: add new feature"
            echo "   fix: resolve bug issue"
            echo "   docs: update documentation"
            exit 1
          fi

      - name: PR Event Info
        run: |
          echo "ğŸ“ PR Event: ${{ github.event.action }}"
          echo "ğŸ”— PR Number: ${{ github.event.pull_request.number }}"
          echo "ğŸ‘¤ Author: ${{ github.event.pull_request.user.login }}"
          echo "ğŸ¯ Target Branch: ${{ github.event.pull_request.base.ref }}"
          echo "ğŸŒ¿ Source Branch: ${{ github.event.pull_request.head.ref }}"
