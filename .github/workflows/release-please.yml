name: Release Please

on:
  # æ¨é€åˆ° main åˆ†æ”¯ - åªæ›´æ–°è‰ç¨¿ï¼Œä¸å‡çº§ç‰ˆæœ¬
  push:
    branches:
      - main
  
  # PR éªŒè¯
  pull_request:
    branches:
      - main
      - '2.4'
      - '2.3'
    types: [opened, synchronize, reopened]

  # æ‰‹åŠ¨è§¦å‘æ­£å¼å‘å¸ƒï¼ˆè¿™æ—¶æ‰å‡çº§ç‰ˆæœ¬ï¼‰
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Type of version bump'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      branch:
        description: 'Target branch for release'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - '2.4'
          - '2.3'

jobs:
  # PR æ ‡é¢˜éªŒè¯
  pr-validation:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Validate PR Title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "ğŸ” Validating PR title: $PR_TITLE"
          
          if echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?!?:\s.+"; then
            echo "âœ… PR title follows conventional commit format"
            echo "ğŸ“ This will be included in the changelog when released"
          else
            echo "âŒ PR title does not follow conventional commit format"
            exit 1
          fi

  # main åˆ†æ”¯æ¨é€ - åªæ›´æ–°è‰ç¨¿ï¼Œä¸å‡çº§ç‰ˆæœ¬
  update-draft:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Latest Tag
        id: latest_tag
        run: |
          # è·å–æœ€æ–°çš„éè‰ç¨¿ tag
          LATEST_TAG=$(git tag --sort=-version:refname | grep -v "draft" | head -1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v1.0.0"
          fi
          
          # è®¡ç®—ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä½œä¸ºè‰ç¨¿ç‰ˆæœ¬
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # é»˜è®¤æŒ‰ minor å‡çº§ä½œä¸ºè‰ç¨¿ç‰ˆæœ¬
          MINOR=$((MINOR + 1))
          PATCH=0
          
          DRAFT_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "draft_version=$DRAFT_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Latest tag: $LATEST_TAG"
          echo "ğŸ“ Draft version: $DRAFT_VERSION"

      - name: Update Draft Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TAG="${{ steps.latest_tag.outputs.latest_tag }}"
          DRAFT_VERSION="${{ steps.latest_tag.outputs.draft_version }}"
          DRAFT_TAG="${DRAFT_VERSION}-draft"
          
          echo "ğŸ”„ Updating draft release: $DRAFT_TAG"
          
          # ç”Ÿæˆä»æœ€æ–° tag ä»¥æ¥çš„ changelog
          CHANGELOG_FILE="/tmp/changelog.md"
          
          # åˆ›å»º changelog æ–‡ä»¶
          echo "## Changes for $DRAFT_VERSION" > $CHANGELOG_FILE
          echo "" >> $CHANGELOG_FILE
          echo "*Based on $LATEST_TAG*" >> $CHANGELOG_FILE
          echo "" >> $CHANGELOG_FILE
          
          # è·å–ä»æœ€æ–° tag åˆ° HEAD çš„æäº¤
          if [ "$LATEST_TAG" != "v1.0.0" ]; then
            COMMITS=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^feat\|^fix\|^perf\|^refactor\|^docs\|^test\|^chore")
          else
            COMMITS=$(git log HEAD --oneline --grep="^feat\|^fix\|^perf\|^refactor\|^docs\|^test\|^chore")
          fi
          
          if [ ! -z "$COMMITS" ]; then
            echo "### ğŸ“ Changes:" >> $CHANGELOG_FILE
            echo "" >> $CHANGELOG_FILE
            while IFS= read -r commit; do
              echo "- $commit" >> $CHANGELOG_FILE
            done <<< "$COMMITS"
          else
            echo "No new changes since last release." >> $CHANGELOG_FILE
          fi
          
          # åˆ é™¤ç°æœ‰çš„è‰ç¨¿ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if gh api repos/${{ github.repository }}/releases/tags/$DRAFT_TAG >/dev/null 2>&1; then
            echo "ğŸ—‘ï¸ Deleting existing draft release..."
            gh api --method DELETE repos/${{ github.repository }}/releases/tags/$DRAFT_TAG || true
            git push --delete origin $DRAFT_TAG || true
            git tag -d $DRAFT_TAG || true
          fi
          
          # åˆ›å»ºæ–°çš„è‰ç¨¿ release
          echo "ğŸ“ Creating new draft release: $DRAFT_TAG"
          gh api repos/${{ github.repository }}/releases \
            -f tag_name="$DRAFT_TAG" \
            -f name="$DRAFT_VERSION (Draft)" \
            -F body="$(cat $CHANGELOG_FILE)" \
            -F draft=true \
            -f target_commitish="main"
          
          echo "âœ… Draft release updated: $DRAFT_TAG"

  # æ‰‹åŠ¨è§¦å‘æ­£å¼å‘å¸ƒ - è¿™æ—¶æ‰å‡çº§ç‰ˆæœ¬
  manual-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Latest Tag and Calculate New Version
        id: version_calc
        run: |
          # è·å–æœ€æ–°çš„éè‰ç¨¿ tag
          LATEST_TAG=$(git tag --sort=-version:refname | grep -v "draft" | head -1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v1.0.0"
          fi
          
          echo "ğŸ“¦ Latest release tag: $LATEST_TAG"
          
          # è§£æç‰ˆæœ¬å·
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # æ ¹æ®è¾“å…¥è®¡ç®—æ–°ç‰ˆæœ¬
          case "${{ github.event.inputs.release_type }}" in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ğŸš€ New version will be: $NEW_VERSION"

      - name: Generate Changelog
        id: changelog
        run: |
          LATEST_TAG="${{ steps.version_calc.outputs.latest_tag }}"
          NEW_VERSION="${{ steps.version_calc.outputs.new_version }}"
          
          echo "ğŸ“‹ Generating changelog from $LATEST_TAG to HEAD"
          
          # åˆ›å»º changelog æ–‡ä»¶
          CHANGELOG_FILE="/tmp/changelog.md"
          echo "## $NEW_VERSION ($(date +%Y-%m-%d))" > $CHANGELOG_FILE
          echo "" >> $CHANGELOG_FILE
          
          # åˆ†ç±»æ”¶é›†æäº¤
          FEATURES=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^feat")
          FIXES=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^fix")
          OTHERS=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^docs\|^style\|^refactor\|^test\|^chore\|^perf\|^ci\|^build")
          
          if [ ! -z "$FEATURES" ]; then
            echo "### ğŸš€ Features" >> $CHANGELOG_FILE
            echo "" >> $CHANGELOG_FILE
            while IFS= read -r commit; do
              echo "- $commit" >> $CHANGELOG_FILE
            done <<< "$FEATURES"
            echo "" >> $CHANGELOG_FILE
          fi
          
          if [ ! -z "$FIXES" ]; then
            echo "### ğŸ› Bug Fixes" >> $CHANGELOG_FILE
            echo "" >> $CHANGELOG_FILE
            while IFS= read -r commit; do
              echo "- $commit" >> $CHANGELOG_FILE
            done <<< "$FIXES"
            echo "" >> $CHANGELOG_FILE
          fi
          
          if [ ! -z "$OTHERS" ]; then
            echo "### ğŸ”§ Other Changes" >> $CHANGELOG_FILE
            echo "" >> $CHANGELOG_FILE
            while IFS= read -r commit; do
              echo "- $commit" >> $CHANGELOG_FILE
            done <<< "$OTHERS"
            echo "" >> $CHANGELOG_FILE
          fi
          
          echo "changelog_file=$CHANGELOG_FILE" >> $GITHUB_OUTPUT

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version_calc.outputs.new_version }}"
          BRANCH="${{ github.event.inputs.branch }}"
          CHANGELOG_FILE="${{ steps.changelog.outputs.changelog_file }}"
          
          echo "ğŸš€ Creating release: $NEW_VERSION on branch: $BRANCH"
          
          # åˆ é™¤å½“å‰è‰ç¨¿ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          # è®¡ç®—å½“å‰åº”è¯¥å­˜åœ¨çš„è‰ç¨¿ç‰ˆæœ¬
          LATEST_TAG="${{ steps.version_calc.outputs.latest_tag }}"
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          CURRENT_DRAFT_MINOR=$((VERSION_PARTS[1] + 1))
          CURRENT_DRAFT_TAG="v${VERSION_PARTS[0]}.${CURRENT_DRAFT_MINOR}.0-draft"
          
          if gh api repos/${{ github.repository }}/releases/tags/$CURRENT_DRAFT_TAG >/dev/null 2>&1; then
            echo "ğŸ—‘ï¸ Cleaning up current draft release: $CURRENT_DRAFT_TAG"
            gh api --method DELETE repos/${{ github.repository }}/releases/tags/$CURRENT_DRAFT_TAG || true
            git push --delete origin $CURRENT_DRAFT_TAG || true
          fi
          
          # åˆ›å»º tag
          git tag $NEW_VERSION HEAD
          git push origin $NEW_VERSION
          
          # åˆ›å»ºæ­£å¼ release
          if [ "$BRANCH" = "2.3" ]; then
            # 2.3 åˆ†æ”¯ - ç¨³å®šç‰ˆæœ¬
            gh release create $NEW_VERSION \
              --title "$NEW_VERSION" \
              --notes-file "$CHANGELOG_FILE" \
              --target "$BRANCH"
          elif [ "$BRANCH" = "2.4" ]; then
            # 2.4 åˆ†æ”¯ - é¢„å‘å¸ƒç‰ˆæœ¬
            gh release create $NEW_VERSION \
              --title "$NEW_VERSION (Pre-release)" \
              --notes-file "$CHANGELOG_FILE" \
              --prerelease \
              --target "$BRANCH"
          else
            # main åˆ†æ”¯ - è‰ç¨¿ç‰ˆæœ¬
            gh release create $NEW_VERSION \
              --title "$NEW_VERSION (Draft)" \
              --notes-file "$CHANGELOG_FILE" \
              --draft \
              --target "$BRANCH"
          fi
          
          echo "âœ… Release $NEW_VERSION created successfully!"

      - name: Update Version Files
        if: github.event.inputs.branch == 'main'
        run: |
          NEW_VERSION="${{ steps.version_calc.outputs.new_version }}"
          VERSION_NUMBER=${NEW_VERSION#v}
          
          # æ›´æ–° version.txt
          echo "$VERSION_NUMBER" > version.txt
          
          # æ›´æ–° manifest
          echo "{\".\": \"$VERSION_NUMBER\"}" > .release-please-manifest.json
          
          # æäº¤ç‰ˆæœ¬æ›´æ–°
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add version.txt .release-please-manifest.json
          git commit -m "chore: release $NEW_VERSION" || true
          git push origin main || true
