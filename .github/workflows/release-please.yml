name: Release Please

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

  pull_request:
    branches:
      - main
      - 2.4
      - 2.3
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'minor'
        type: choice
        options:
          - major
          - minor
          - patch
      branch:
        description: 'Target branch'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - 2.4
          - 2.3

permissions:
  contents: write
  pull-requests: write

jobs:
  # PR æ ‡é¢˜éªŒè¯
  validate-pr-title:
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate PR Title for Conventional Commits
        run: |

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR äº‹ä»¶ - æ£€æŸ¥ PR æ ‡é¢˜
            PR_TITLE="${{ github.event.pull_request.title }}"
            echo "ğŸ” Checking PR title: $PR_TITLE"
            CHECK_MSG="$PR_TITLE"
          else
            # Push äº‹ä»¶ - æ£€æŸ¥æœ€æ–° commit
            COMMIT_MSG=$(git log -1 --pretty=format:'%s')
            echo "ğŸ” Checking commit: $COMMIT_MSG"
            CHECK_MSG="$COMMIT_MSG"
          fi
          
          # æ£€æŸ¥æ˜¯å¦ç¬¦åˆå¸¸è§„æäº¤æ ¼å¼
          if echo "$CHECK_MSG" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)(\(.+\))?: .+'; then
            echo "âœ… Title/Commit follows conventional format"
          else
            echo "âŒ Title/Commit does not follow conventional format"
            echo "Expected format: type(scope): description"
            echo "Valid types: feat, fix, docs, style, refactor, test, chore, perf, ci, build"
            exit 1
          fi


  # åˆ›å»ºè‰ç¨¿å‘å¸ƒ
  create-draft:
    if: github.event_name == 'push'
    needs: validate-pr-title
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Get Latest Tag and Calculate Draft Version
        id: latest_tag
        run: |
          # è·å–æœ€æ–°çš„æ­£å¼å‘å¸ƒ tagï¼ˆæ’é™¤è‰ç¨¿ï¼‰
          LATEST_TAG=$(git tag --sort=-version:refname | grep -v "draft" | head -1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v1.0.0"
          fi
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Latest release tag: $LATEST_TAG"
          
          # è®¡ç®—ä¸‹ä¸€ä¸ªç‰ˆæœ¬å·
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # æ£€æŸ¥ä»æœ€æ–° tag åˆ° HEAD çš„æäº¤æ¥å†³å®šç‰ˆæœ¬å‡çº§ç­–ç•¥
          HAS_FEAT=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^feat" | wc -l)
          HAS_BREAKING=$(git log ${LATEST_TAG}..HEAD --oneline --grep="BREAKING CHANGE\|!" | wc -l)
          
          if [ "$HAS_BREAKING" -gt 0 ]; then
            # æœ‰ç ´åæ€§å˜æ›´ -> major ç‰ˆæœ¬å‡çº§
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
          elif [ "$HAS_FEAT" -gt 0 ]; then
            # æœ‰æ–°åŠŸèƒ½ -> minor ç‰ˆæœ¬å‡çº§
            MINOR=$((MINOR + 1))
            PATCH=0
          else
            # åªæœ‰ä¿®å¤æˆ–å…¶ä»– -> patch ç‰ˆæœ¬å‡çº§
            PATCH=$((PATCH + 1))
          fi
          
          DRAFT_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "draft_version=$DRAFT_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ”„ Draft version: $DRAFT_VERSION"

      - name: Update Draft Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TAG="${{ steps.latest_tag.outputs.latest_tag }}"
          DRAFT_VERSION="${{ steps.latest_tag.outputs.draft_version }}"
          DRAFT_TAG="${DRAFT_VERSION}-draft"
          
          echo "ğŸ”„ Updating draft release: $DRAFT_TAG"
          

          # ç”Ÿæˆç»Ÿä¸€çš„ changelog å†…å®¹ï¼ˆæ¸…ç†ç‰ˆæœ¬ï¼‰
          generate_changelog() {
            local VERSION=$1
            local LATEST_TAG=$2
            local OUTPUT_FILE=$3
            
            echo "## $VERSION ($(date +%Y-%m-%d))" > $OUTPUT_FILE
            echo "" >> $OUTPUT_FILE
            
            # åˆ†ç±»æ”¶é›†ä»æœ€æ–° tag åˆ° HEAD çš„æäº¤
            if [ "$LATEST_TAG" != "v1.0.0" ]; then
              FEATURES=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^feat")
              FIXES=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^fix")
              OTHERS=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^docs\|^style\|^refactor\|^test\|^chore\|^perf\|^ci\|^build")
            else
              FEATURES=$(git log HEAD --oneline --grep="^feat")
              FIXES=$(git log HEAD --oneline --grep="^fix")
              OTHERS=$(git log HEAD --oneline --grep="^docs\|^style\|^refactor\|^test\|^chore\|^perf\|^ci\|^build")
            fi
            
            # æ·»åŠ  Features
            if [ ! -z "$FEATURES" ]; then
              echo "### ğŸš€ Features" >> $OUTPUT_FILE
              echo "" >> $OUTPUT_FILE
              while IFS= read -r commit; do
                COMMIT_HASH=$(echo "$commit" | cut -d' ' -f1)
                COMMIT_MSG=$(echo "$commit" | cut -d' ' -f2-)
                # æ¸…ç† commit ä¿¡æ¯ï¼Œå»æ‰ feat: å‰ç¼€
                CLEAN_MSG=$(echo "$COMMIT_MSG" | sed 's/^feat[(:][^)]*[)]:\s*//' | sed 's/^feat:\s*//')
                echo "* $CLEAN_MSG ([$COMMIT_HASH](https://github.com/${{ github.repository }}/commit/$COMMIT_HASH))" >> $OUTPUT_FILE
              done <<< "$FEATURES"
              echo "" >> $OUTPUT_FILE
            fi
            
            # æ·»åŠ  Bug Fixes
            if [ ! -z "$FIXES" ]; then
              echo "### ğŸ› Bug Fixes" >> $OUTPUT_FILE
              echo "" >> $OUTPUT_FILE
              while IFS= read -r commit; do
                COMMIT_HASH=$(echo "$commit" | cut -d' ' -f1)
                COMMIT_MSG=$(echo "$commit" | cut -d' ' -f2-)
                # æ¸…ç† commit ä¿¡æ¯ï¼Œå»æ‰ fix: å‰ç¼€
                CLEAN_MSG=$(echo "$COMMIT_MSG" | sed 's/^fix[(:][^)]*[)]:\s*//' | sed 's/^fix:\s*//')
                echo "* $CLEAN_MSG ([$COMMIT_HASH](https://github.com/${{ github.repository }}/commit/$COMMIT_HASH))" >> $OUTPUT_FILE
              done <<< "$FIXES"
              echo "" >> $OUTPUT_FILE
            fi
            
            # æ·»åŠ  Other Changes
            if [ ! -z "$OTHERS" ]; then
              echo "### ğŸ”§ Other Changes" >> $OUTPUT_FILE
              echo "" >> $OUTPUT_FILE
              while IFS= read -r commit; do
                COMMIT_HASH=$(echo "$commit" | cut -d' ' -f1)
                COMMIT_MSG=$(echo "$commit" | cut -d' ' -f2-)
                # æ¸…ç† commit ä¿¡æ¯ï¼Œå»æ‰ç±»å‹å‰ç¼€
                CLEAN_MSG=$(echo "$COMMIT_MSG" | sed -E 's/^(docs|style|refactor|test|chore|perf|ci|build)[(:][^)]*[)]:\s*//' | sed -E 's/^(docs|style|refactor|test|chore|perf|ci|build):\s*//')
                echo "* $CLEAN_MSG ([$COMMIT_HASH](https://github.com/${{ github.repository }}/commit/$COMMIT_HASH))" >> $OUTPUT_FILE
              done <<< "$OTHERS"
              echo "" >> $OUTPUT_FILE
            fi
            
            # å¦‚æœæ²¡æœ‰ä»»ä½•å˜æ›´
            if [ -z "$FEATURES" ] && [ -z "$FIXES" ] && [ -z "$OTHERS" ]; then
              echo "No new changes since last release." >> $OUTPUT_FILE
            fi
          }
          
          # ç”Ÿæˆ changelog
          CHANGELOG_FILE="/tmp/changelog.md"
          generate_changelog "$DRAFT_VERSION" "$LATEST_TAG" "$CHANGELOG_FILE"
          
          # åˆ é™¤ç°æœ‰çš„è‰ç¨¿ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if gh api repos/${{ github.repository }}/releases/tags/$DRAFT_TAG >/dev/null 2>&1; then
            echo "ğŸ—‘ï¸ Deleting existing draft release..."
            gh api --method DELETE repos/${{ github.repository }}/releases/tags/$DRAFT_TAG || true
            git push --delete origin $DRAFT_TAG || true
            git tag -d $DRAFT_TAG || true
          fi
          
          # åˆ›å»ºæ–°çš„è‰ç¨¿ release
          echo "ğŸ“ Creating new draft release: $DRAFT_TAG"
          gh api repos/${{ github.repository }}/releases \
            -f tag_name="$DRAFT_TAG" \
            -f name="$DRAFT_VERSION (Draft)" \
            -F body="$(cat $CHANGELOG_FILE)" \
            -F draft=true \
            -f target_commitish="main"
          
          echo "âœ… Draft release updated: $DRAFT_TAG"


  # æ‰‹åŠ¨æ­£å¼å‘å¸ƒ
  manual-release:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Calculate New Version
        id: version_calc
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "ğŸ“Œ Latest tag: $LATEST_TAG"
          
          # è§£æå½“å‰ç‰ˆæœ¬
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}
          
          # æ ¹æ®è¾“å…¥è®¡ç®—æ–°ç‰ˆæœ¬
          case "${{ github.event.inputs.release_type }}" in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ğŸš€ New version will be: $NEW_VERSION"

      - name: Generate Changelog
        id: changelog
        run: |
          LATEST_TAG="${{ steps.version_calc.outputs.latest_tag }}"
          NEW_VERSION="${{ steps.version_calc.outputs.new_version }}"
          
          echo "ğŸ“‹ Generating changelog from $LATEST_TAG to HEAD"
          

          # ä½¿ç”¨ç»Ÿä¸€çš„ changelog ç”Ÿæˆå‡½æ•°
          generate_changelog() {
            local VERSION=$1
            local LATEST_TAG=$2
            local OUTPUT_FILE=$3
            local IS_RELEASE=$4
            
            if [ "$IS_RELEASE" = "true" ]; then
              echo "## [$VERSION](https://github.com/${{ github.repository }}/releases/tag/$VERSION) ($(date +%Y-%m-%d))" > $OUTPUT_FILE
            else
              echo "## $VERSION ($(date +%Y-%m-%d))" > $OUTPUT_FILE
            fi
            echo "" >> $OUTPUT_FILE
            
            # åˆ†ç±»æ”¶é›†æäº¤
            FEATURES=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^feat")
            FIXES=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^fix")
            OTHERS=$(git log ${LATEST_TAG}..HEAD --oneline --grep="^docs\|^style\|^refactor\|^test\|^chore\|^perf\|^ci\|^build")
            
            # æ·»åŠ  Features
            if [ ! -z "$FEATURES" ]; then
              echo "### ğŸš€ Features" >> $OUTPUT_FILE
              echo "" >> $OUTPUT_FILE
              while IFS= read -r commit; do
                COMMIT_HASH=$(echo "$commit" | cut -d' ' -f1)
                COMMIT_MSG=$(echo "$commit" | cut -d' ' -f2-)
                # æ¸…ç† commit ä¿¡æ¯ï¼Œå»æ‰ feat: å‰ç¼€
                CLEAN_MSG=$(echo "$COMMIT_MSG" | sed 's/^feat[(:][^)]*[)]:\s*//' | sed 's/^feat:\s*//')
                echo "* $CLEAN_MSG ([$COMMIT_HASH](https://github.com/${{ github.repository }}/commit/$COMMIT_HASH))" >> $OUTPUT_FILE
              done <<< "$FEATURES"
              echo "" >> $OUTPUT_FILE
            fi
            
            # æ·»åŠ  Bug Fixes
            if [ ! -z "$FIXES" ]; then
              echo "### ğŸ› Bug Fixes" >> $OUTPUT_FILE
              echo "" >> $OUTPUT_FILE
              while IFS= read -r commit; do
                COMMIT_HASH=$(echo "$commit" | cut -d' ' -f1)
                COMMIT_MSG=$(echo "$commit" | cut -d' ' -f2-)
                # æ¸…ç† commit ä¿¡æ¯ï¼Œå»æ‰ fix: å‰ç¼€
                CLEAN_MSG=$(echo "$COMMIT_MSG" | sed 's/^fix[(:][^)]*[)]:\s*//' | sed 's/^fix:\s*//')
                echo "* $CLEAN_MSG ([$COMMIT_HASH](https://github.com/${{ github.repository }}/commit/$COMMIT_HASH))" >> $OUTPUT_FILE
              done <<< "$FIXES"
              echo "" >> $OUTPUT_FILE
            fi
            
            # æ·»åŠ  Other Changes
            if [ ! -z "$OTHERS" ]; then
              echo "### ğŸ”§ Other Changes" >> $OUTPUT_FILE
              echo "" >> $OUTPUT_FILE
              while IFS= read -r commit; do
                COMMIT_HASH=$(echo "$commit" | cut -d' ' -f1)
                COMMIT_MSG=$(echo "$commit" | cut -d' ' -f2-)
                # æ¸…ç† commit ä¿¡æ¯ï¼Œå»æ‰ç±»å‹å‰ç¼€
                CLEAN_MSG=$(echo "$COMMIT_MSG" | sed -E 's/^(docs|style|refactor|test|chore|perf|ci|build)[(:][^)]*[)]:\s*//' | sed -E 's/^(docs|style|refactor|test|chore|perf|ci|build):\s*//')
                echo "* $CLEAN_MSG ([$COMMIT_HASH](https://github.com/${{ github.repository }}/commit/$COMMIT_HASH))" >> $OUTPUT_FILE
              done <<< "$OTHERS"
              echo "" >> $OUTPUT_FILE
            fi
            
            # å¦‚æœæ²¡æœ‰ä»»ä½•å˜æ›´
            if [ -z "$FEATURES" ] && [ -z "$FIXES" ] && [ -z "$OTHERS" ]; then
              echo "No new changes since last release." >> $OUTPUT_FILE
            fi
          }
          
          # ç”Ÿæˆ changelog - æ­£å¼å‘å¸ƒç‰ˆæœ¬
          CHANGELOG_FILE="/tmp/changelog.md"
          generate_changelog "$NEW_VERSION" "$LATEST_TAG" "$CHANGELOG_FILE" "true"
          
          echo "changelog_file=$CHANGELOG_FILE" >> $GITHUB_OUTPUT

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEW_VERSION="${{ steps.version_calc.outputs.new_version }}"
          BRANCH="${{ github.event.inputs.branch }}"
          CHANGELOG_FILE="${{ steps.changelog.outputs.changelog_file }}"
          
          echo "ğŸš€ Creating release: $NEW_VERSION on branch: $BRANCH"
          
          # åˆ é™¤å½“å‰è‰ç¨¿ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          # è®¡ç®—å½“å‰åº”è¯¥å­˜åœ¨çš„è‰ç¨¿ç‰ˆæœ¬
          LATEST_TAG="${{ steps.version_calc.outputs.latest_tag }}"
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r -a VERSION_PARTS <<< "$VERSION"
          CURRENT_DRAFT_MINOR=$((VERSION_PARTS[1] + 1))
          CURRENT_DRAFT_TAG="v${VERSION_PARTS[0]}.${CURRENT_DRAFT_MINOR}.0-draft"
          
          if gh api repos/${{ github.repository }}/releases/tags/$CURRENT_DRAFT_TAG >/dev/null 2>&1; then
            echo "ğŸ—‘ï¸ Cleaning up current draft release: $CURRENT_DRAFT_TAG"
            gh api --method DELETE repos/${{ github.repository }}/releases/tags/$CURRENT_DRAFT_TAG || true
            git push --delete origin $CURRENT_DRAFT_TAG || true
          fi
          
          # åˆ›å»º tag
          git tag $NEW_VERSION HEAD
          git push origin $NEW_VERSION
          
          # åˆ›å»ºæ­£å¼ release
          if [ "$BRANCH" = "2.3" ]; then
            # 2.3 åˆ†æ”¯ - ç¨³å®šç‰ˆæœ¬
            gh release create $NEW_VERSION \
              --title "$NEW_VERSION" \
              --notes-file "$CHANGELOG_FILE" \
              --target "$BRANCH"
          elif [ "$BRANCH" = "2.4" ]; then
            # 2.4 åˆ†æ”¯ - é¢„å‘å¸ƒç‰ˆæœ¬
            gh release create $NEW_VERSION \
              --title "$NEW_VERSION (Pre-release)" \
              --notes-file "$CHANGELOG_FILE" \
              --prerelease \
              --target "$BRANCH"
          else
            # main åˆ†æ”¯ - è‰ç¨¿ç‰ˆæœ¬
            gh release create $NEW_VERSION \
              --title "$NEW_VERSION (Draft)" \
              --notes-file "$CHANGELOG_FILE" \
              --draft \
              --target "$BRANCH"
          fi
          
          echo "âœ… Release $NEW_VERSION created successfully!"

      - name: Update Version Files and CHANGELOG
        if: github.event.inputs.branch == 'main'
        run: |
          NEW_VERSION="${{ steps.version_calc.outputs.new_version }}"
          LATEST_TAG="${{ steps.version_calc.outputs.latest_tag }}"
          VERSION_NUMBER=${NEW_VERSION#v}
          
          echo "ğŸ“ Updating version files and CHANGELOG.md"
          
          # æ›´æ–° version.txt
          echo "$VERSION_NUMBER" > version.txt
          
          # æ›´æ–° manifest
          echo "{\".\": \"$VERSION_NUMBER\"}" > .release-please-manifest.json
          
          # æ›´æ–° CHANGELOG.md - ç§»é™¤è‰ç¨¿æ¡ç›®å¹¶æ·»åŠ æ­£å¼ç‰ˆæœ¬
          CHANGELOG_FILE="${{ steps.changelog.outputs.changelog_file }}"
          
          # ç§»é™¤ç°æœ‰çš„è‰ç¨¿æ¡ç›®
          DRAFT_VERSION_MINOR=$(($(echo $LATEST_TAG | sed 's/v[0-9]*\.\([0-9]*\)\.[0-9]*/\1/') + 1))
          DRAFT_VERSION="v$(echo $LATEST_TAG | sed 's/v\([0-9]*\)\.[0-9]*\.[0-9]*/\1/').$DRAFT_VERSION_MINOR.0"
          
          if grep -q "## \[$DRAFT_VERSION\]" CHANGELOG.md; then
            echo "ğŸ—‘ï¸ Removing draft entry from CHANGELOG.md"
            sed -i.bak "/^## \[$DRAFT_VERSION\]/,/^## \[/{ /^## \[/!d; }" CHANGELOG.md
            sed -i.bak "/^## \[$DRAFT_VERSION\]/d" CHANGELOG.md
          fi
          
          # æ·»åŠ æ­£å¼ç‰ˆæœ¬æ¡ç›®
          {
            head -2 CHANGELOG.md  # ä¿ç•™æ ‡é¢˜
            echo ""
            cat $CHANGELOG_FILE   # æ·»åŠ æ–°çš„æ­£å¼ç‰ˆæœ¬
            echo ""
            tail -n +3 CHANGELOG.md  # ä¿ç•™å…¶ä½™å†…å®¹
          } > CHANGELOG.md.tmp && mv CHANGELOG.md.tmp CHANGELOG.md
          
          # æäº¤æ‰€æœ‰æ›´æ”¹
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add version.txt .release-please-manifest.json CHANGELOG.md
          git commit -m "chore: release $NEW_VERSION" || true
          git push origin main || true
          
          echo "âœ… Version files and CHANGELOG.md updated successfully"